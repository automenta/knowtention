<html>
    <head>
        <title>?</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="lib/jquery-2.1.1.min.js"></script>
        <script src="lib/lodash.min.js"></script>
        <script src="lib/cytoscape.js"></script>
        <!-- <script src="lib/json-patch-duplex.min.js"></script> --> 
        <script src="lib/jsonsynch.min.js"></script>
        <script src="lib/web_socket.js"></script>

        <script src="lib/html2json/html2json.js"></script>
        <script src="lib/html2json/htmlparser.js"></script>

        <link type="text/css" rel="stylesheet" href="lib/foundation/foundation.min.css"  media="screen,projection"/>
        <script type="text/javascript" src="lib/foundation/foundation.min.js"></script>

        <link type="text/css" rel="stylesheet" href="spacegraph.css"/>
        <link type="text/css" rel="stylesheet" href="spacegraph.bright.css"/>

        <script src="lib/modernizr.js"></script>
        <script src="lib/fastclick.js"></script>

        <script src="core.js"></script>
        <script src="websocket.js"></script>
        <script src="spacegraph.js"></script>
        <script src="example_channels.js"></script>

    </head>
    <body>
        <nav class="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
                <li class="toggle-topbar menu-icon"><a href="#"><span>[~]</span></a></li>
            </ul>

            <section class="top-bar-section">
                <!-- Right Nav Section -->
                <ul class="right">
                    <li><a href="#what">What</a></li>
                    <li><a href="#who">Who</a></li>
                    <li><a href="#where">Where</a></li>
                    <li><a href="#when">When</a></li>
                    <li><a href="#why">Why</a></li>

                    <li class="has-dropdown">
                        <a href="#">Now</a>        
                        <ul class="dropdown">
                            <li><a href="#">Be</a></li>
                            <li><a href="#">Do</a></li>                            
                            <li><a href="#">Know</a></li>
                            <!--<li class="active"><a href="#">Active link in dropdown</a></li>-->
                        </ul>
                    </li>
                </ul>

                <!-- Left Nav Section -->
                <ul class="left">
                    <!--<li><input type="text"></input></li>-->
                </ul>
            </section>
        </nav>



        <div id="graph">
            <!-- cytoscape render here -->
        </div>
        <div id="widgets">
            <!-- cytoscape render here -->
        </div>


        
        <script>$(document).foundation();</script>
    </body>

    <script>


        
        var Channel = function(initialData, socket) {
            
            var c = {
                ui: null,
                data: initialData,
                socket: socket,
                prev: { },
                
                id: function() { return this.data.id; }                
            };
            
            c.init = function(ui) {                
                this.ui = ui;
                
                this.commit();
            };
            
            var synchPeriodMS = 1500;
            
            c.commit = _.throttle(function() {
                
                if (!this.socket.opened) {
                    return;
                }                

                //get positions
                var eles = this.ui.elements();
                var P = {};
                for (var i = 0; i < eles.length; i++) {
                    var ele = eles[i];
                    //console.log( ele.id() + ' is ' + ( ele.selected() ? 'selected' : 'not selected' ) );
                    var p = ele.position();
                    var x = p.x;
                    if (!isFinite(x))
                        continue;
                    var y = p.y;
                    P[ele.id()] = [parseInt(x), parseInt(y)];
                }
                this.data.p = P; //positions; using 1 character because this is updated frequently

                //https://github.com/Starcounter-Jack/Fast-JSON-Patch
                var diff = jsonpatch.compare(this.prev, this.data);

                this.prev = _.clone(this.data, true);

                if (diff.length > 0) {
                    var diffString = JSON.stringify(['p', this.data.id, diff]);
                    
                    console.log('session diff', diffString.length, diffString);
                    
                    this.socket.send(diffString);
                }
        
            }, synchPeriodMS);
            
            return c;
        };

        var sg = spacegraph($('#graph'), {

            start: function() {                      
                window.ws = websocketConnect();
                sg.addChannel(new Channel( newExampleChannel1(), ws));
            }
            
        });
        
        




    </script>
</html>
