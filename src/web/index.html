<html>
    <head>
        <title>?</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="lib/jquery-2.1.1.min.js"></script>
        <script src="lib/lodash.min.js"></script>
        <script src="lib/cytoscape.js"></script>
        <script src="lib/json-patch-duplex.min.js"></script>
        <script src="lib/web_socket.js"></script>

        <link type="text/css" rel="stylesheet" href="lib/materialize/css/materialize.min.css"  media="screen,projection"/>

        <script type="text/javascript" src="lib/materialize/js/materialize.min.js"></script>
        <style>
            body {
                margin: 0;
                width: 100%;
                height: 100%;
                border: 0;
                padding: 0;    
            }
            #menubar {
                position: fixed;
                top:0;
                right: 0;
                opacity:0.95;
                z-index: 10000;
            }
            #graph, #widgets {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;                    
            }
            #widgets {
                pointer-events: none;
            }
            .widget {
                pointer-events: none;
            }

            .widget * {
                pointer-events: all;
            }
            .editable {
                width: 95%;
                background-color: white;
                margin: 4px;
                opacity: 0.9;
            }
        </style>

    </head>
    <body>

        <nav id='menubar'>
            <div class="nav-wrapper light-green darken-2">
                <!--<a href="#" class="brand-logo">Logo</a>-->
                <ul id="nav-mobile" class="right side-nav">
                    <li><a href="sass.html">Sass</a></li>
                    <li><a href="components.html">Components</a></li>
                    <li><a href="javascript.html">JavaScript</a></li>
                </ul>
                <a class="button-collapse" href="#" data-activates="nav-mobile"><i class="mdi-navigation-menu"></i></a>
            </div>
        </nav>

        <div id="graph">
            <!-- cytoscape render here -->
        </div>
        <div id="widgets">
            <!-- cytoscape render here -->
        </div>
    </body>

    <script>



        var session = {
            id: 'defaultClient' + parseInt(Math.random()*10000),
            style: [
                {
                    selector: 'node',
                    css: {
                        'content': 'data(name)',
                        'text-valign': 'center',
                        'text-halign': 'center'
                    }
                },
                {
                    selector: '$node > node',
                    css: {
                        'padding-top': '5px',
                        'padding-left': '5px',
                        'padding-bottom': '5px',
                        'padding-right': '5px',
                        'text-valign': 'top',
                        'text-halign': 'center'
                    }
                },
                {
                    selector: 'edge',
                    css: {
                        'target-arrow-shape': 'triangle'
                    }
                },
                {
                    selector: ':selected',
                    css: {
                        'background-color': 'black',
                        'line-color': 'black',
                        'target-arrow-color': 'black',
                        'source-arrow-color': 'black'
                    }
                }
            ],
            elements: {
                nodes: [
                    {data: {id: 'a', parent: 'b'}},
                    {data: {id: 'b'}},
                    {data: {id: 'c', parent: 'b'}},
                    {data: {id: 'd',
                            widget: {
                                html: '<h1>=D</h1>',
                                //html: '<iframe width="600px" height="600px" src="http://en.wikipedia.org/wiki/MaidSafe"></iframe><br/><button>x</button>',
                                scale: 1 / 600.0,
                                minPixels: 2,
                                padding: 0.1
                            }
                        }},
                    {data: {id: 'e',
                            widget: {
                                html: '<div style="background-color: orange; border: 2px solid black;"><div contenteditable="true" class="editable">WTF</div><br/><button>OK</button></div>',
                                style: {width: '300px', height: '260px'},
                                scale: 1 / 300.0,
                                minPixels: 32,
                                padding: 0.25
                            }
                        }},
                    {data: {id: 'f', parent: 'e'}}
                ],
                edges: [
                    {data: {id: 'ad', source: 'a', target: 'd'}},
                    {data: {id: 'eb', source: 'e', target: 'b'}}

                ]
            }
        },
        prevSession = {};

        function _synchSession() {

            //get positions
            var eles = window.cy.elements();
            var P = {};
            for (var i = 0; i < eles.length; i++) {
                var ele = eles[i];
                //console.log( ele.id() + ' is ' + ( ele.selected() ? 'selected' : 'not selected' ) );
                var p = ele.position();
                var x = p.x;
                if (!isFinite(x))
                    continue;
                var y = p.y;
                P[ele.id()] = [parseInt(x), parseInt(y)];
            }
            session.positions = P;

            //https://github.com/Starcounter-Jack/Fast-JSON-Patch
            var diff = jsonpatch.compare(prevSession, session);

            prevSession = jQuery.extend(true, {}, session);

            if (diff.length > 0) {
                var diffString = JSON.stringify(['p',session.id,diff]);
                console.log('session diff', diffString.length, diffString);
                ws.send(diffString);
            }

        }
        var synchSession = _.throttle(_synchSession, 1500);

        function commit() {
            if (ws.opened) {
                synchSession();
            } else {
                //nothing
            }
        }



        $('#graph').cytoscape({
            style: session.style,
            elements: session.elements,
            layout: {
                name: 'cose',
                padding: 5
            },
            ready: function () {                
                window.cy = this;
                
                initWebSocket();
                initEvents(this);

            },
            // initial viewport state:
            zoom: 1,
            pan: {x: 0, y: 0},
            // interaction options:
            minZoom: 1e-50,
            maxZoom: 1e50,
            zoomingEnabled: true,
            userZoomingEnabled: true,
            panningEnabled: true,
            userPanningEnabled: true,
            selectionType: 'single',
            boxSelectionEnabled: false,
            autolock: false,
            autoungrabify: false,
            autounselectify: false,
            // rendering options:
            headless: false,
            styleEnabled: true,
            hideEdgesOnViewport: false,
            hideLabelsOnViewport: false,
            textureOnViewport: false, //true = higher performance, lower quality
            motionBlur: true,
            wheelSensitivity: 1,
            //pixelRatio: 1
            initrender: function (evt) { /* ... */

            }
            //renderer: { /* ... */},
        });

        function initEvents(cv) {
            //events

            //http://js.cytoscape.org/#events/collection-events
            //
            cv.on('data position select unselect add remove grab drag style', function (evt) {
                /*console.log( evt.data.foo ); // 'bar'
                 
                 var node = evt.cyTarget;
                 console.log( 'tapped ' + node.id() );*/

                var target = evt.cyTarget;
                if (widget(target))
                    queueWidgetUpdate(target);

                commit();
            });

            var widgetsToUpdate = {};

//            var baseRedraw = cy._private.renderer.redraw;
//            cy._private.renderer.redraw = function(options) {
//
//                
//                baseRedraw.apply(this, arguments);
//            };

            var baseDrawNode = cy._private.renderer.drawNode;
            cy._private.renderer.drawNode = function (context, node, drawOverlayInstead) {
                baseDrawNode.apply(this, arguments);

                if (widget(node)) {
                    queueWidgetUpdate(node);
                }
            };

            function widget(node) {
                return node.data().widget;
            }

            function queueWidgetUpdate(node) {
                widgetsToUpdate[node.id()] = node;
                updateWidgets();
            }

            var updateWidgets = _.throttle(function () {

                var nextWidgetsToUpdate = _.values(widgetsToUpdate);

                if (nextWidgetsToUpdate.length > 0) {
                    widgetsToUpdate = {};

                    setTimeout(function () {

                        for (var i = 0; i < nextWidgetsToUpdate.length; i++) {
                            var node = nextWidgetsToUpdate[i];
                            updateNodeWidget(node);
                        }

                    }, 0);
                }

            }, 10);

            var widgets = new WeakMap();

            function updateNodeWidget(node) {
                var widget = node.data().widget; //html string
                var w = widgets.get(node);


                if (!w) {

                    var style = widget.style || {};
                    style.position = 'fixed';
                    style.transformOrigin = '0 0';

                    w = $('<div></div>').addClass('widget').css(style).appendTo('#widgets');
                    w.html(widget.html);

                    widgets.set(node, w);
                }


                var pos = node.renderedPosition();
                var pw = node.renderedWidth();
                var ph = node.renderedHeight();
                var paddingScale = (widget.padding || 0);

                var ps = Math.min(pw, ph) * (1.0 - paddingScale);

                var widgetScale = widget.scale;
                var wx = ps * widgetScale;

                var nextCSS = {};
                if (widget.minPixels) {
                    var hidden = 'none' === w.css('display');

                    if (ps < widget.minPixels) {
                        if (!hidden) {
                            w.css({display: 'none'});
                            return;
                        }
                    }
                    else {
                        if (hidden) {
                            nextCSS['display'] = 'block';
                        }
                    }
                }

                var mata, matb, matc, matd, mate, matf;
                mata = wx;
                matb = 0;
                matc = 0;
                matd = wx;
                mate = parseInt(pos.x - pw / 2 + pw * paddingScale / 2.0);
                matf = parseInt(pos.y - ph / 2 + ph * paddingScale / 2.0);
                nextCSS['transform'] = 'matrix(' + mata + ',' + matb + ',' + matc + ',' + matd + ',' + mate + ',' + matf + ')';
                w.css(nextCSS);
            }


//            function scaleAndTranslate( _element , _x , _y, wx, wy )  {
//                
//                var mat = _element.style.transform.baseVal.getItem(0).matrix;
//                // [1 0 0 1 tx ty], 
//                mat.a = wx; mat.b = 0; mat.c = 0; mat.d = wy; mat.e = _x; mat.f = _y;
//                
//            }        
        }


        function initWebSocket() {
            $(document).ready(function () {

                var url = (window.location + '');
                url = url.substring(url.indexOf('://') + 3);

                window.ws = new WebSocket('ws://' + url + 'ws');
                ws.onopen = function () {

                    this.opened = true;

                    console.log('websocket connected');

                    commit();


                };
                ws.onmessage = function (e) {
                    /*e.data.split("\n").forEach(function (l) {
                        output(l, true);
                    });*/

                    console.log('websocket in', e.data);

                };
                ws.onclose = function () {
                    //already disconnected?
                    if (!this.opened)
                        return;

                    this.opened = false;

                    console.log("Websocket disconnected");

                    //attempt reconnect?
                };
                ws.onerror = function(e) {
                    console.log("Websocket error", e);
                };
    //
            });
        }


    </script>
</html>
